#!/usr/bin/env ruby

$:.unshift(File::join(File::dirname(File::dirname(__FILE__)), "lib"))

require 'rubygems' unless RUBY_VERSION =~ /1.9.*/
require 'jar_wrapper'

class WinstoneStarter

  USAGE= <<-TEXT
    Usage:
      winstone help                 - this help
      winstone install              - installs winstone
      winstone <server-params>      - runs the winstone server
      winstone lite <server-params> - runs winstone (lite) server
      winstone tool <tool-params>   - runs winstone tool
  TEXT

  def initialize
    @wrapper = JarWrapper.new
  end

  def run
    install_dir = ENV['HOME'] + "/.winstone/assets"
    verion = "0.9.10"
    
    source1 = "http://surfnet.dl.sourceforge.net/project/winstone/winstone/v#{verion}/winstone-#{verion}.jar"
    source2 = "http://surfnet.dl.sourceforge.net/project/winstone/winstone/v#{verion}/winstone-lite-#{verion}.jar"

    target1 = install_dir + "/winstone-#{verion}.jar"
    target2 = install_dir + "/winstone-lite-#{verion}.jar"

    jar_file1 = install_dir + "/winstone-#{verion}.jar"
    jar_file2 = install_dir + "/winstone-lite-#{verion}.jar"

    param = ARGV.length == 0 ? "" : ARGV.first

    case param
      when /(-v)|(--version)/ then
        puts "Version: #{File.open(File::dirname(__FILE__) + "/../VERSION").readlines().first}"
      when 'install' then
        @wrapper.install source1, target1
        @wrapper.install source2, target2
        puts
      when 'help' then
        puts USAGE and return
      when 'lite' then
        @wrapper.run_jar 'winstone', jar_file2, ["-Xmx1024m", "-Xss1024k" ], ARGV
       when 'tool' then
        ARGV.shift
        main_class = ARGV.shift
        class_path = jar_file1
        @wrapper.run_cp 'winstone', class_path, main_class, ["-Xmx1024m", "-Xss1024k" ], ARGV
      else
        @wrapper.run_jar 'winstone', jar_file1, ["-Xmx1024m", "-Xss1024k" ], ARGV
    end
  end
end

WinstoneStarter.new.run
